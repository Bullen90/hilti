# $Id$
#
# @TEST-EXEC:  hilti-build2 %INPUT -o a.out
# @TEST-EXEC:  ./a.out >output 2>&1
# @TEST-EXEC:  btest-diff output

module Main

import Hilti

void other() {
     call Hilti::print("doing other")
}

void reader(ref<channel<int32>> ch) {

     local int32 n

     # Schedule to same thread. When we yield, this one will get
     # executed.
     thread.schedule 1 other()

     call Hilti::print("doing read")
     n = channel.read ch
     call Hilti::print("done with read")
     call Hilti::print(n)
}

void run() {
    local ref<channel<int32>> ch
    ch = new channel<int32>
    local int32 a
    local int32 b
    local int32 c

    thread.schedule 1 reader(ch)

    call Hilti::sleep(0.5)

    call Hilti::print("doing write")
    channel.write ch 42
}
